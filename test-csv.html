<!DOCTYPE html>
<html>
<head>
    <title>CSV Test</title>
</head>
<body>
    <h1>CSV Storage Test</h1>
    <button onclick="testCSV()">Test CSV Functions</button>
    <button onclick="clearData()">Clear All Data</button>
    <button onclick="downloadUserData()">Download Users CSV</button>
    <button onclick="downloadOrderData()">Download Orders CSV</button>
    <div id="output"></div>

    <script>
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0 || lines[0] === '') return [];
            
            const headers = lines[0].split(',');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                data.push(obj);
            }
            return data;
        }

        function arrayToCSV(array, headers) {
            if (array.length === 0) return headers.join(',') + '\n';
            
            const csvContent = headers.join(',') + '\n' + 
                array.map(row => headers.map(header => row[header] || '').join(',')).join('\n');
            return csvContent;
        }

        function downloadCSV(filename, csvContent) {
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function loadCSVData(key) {
            const csvData = localStorage.getItem(key);
            if (!csvData) return [];
            return parseCSV(csvData);
        }

        function saveCSVData(key, data, headers) {
            const csvContent = arrayToCSV(data, headers);
            localStorage.setItem(key, csvContent);
        }

        function testCSV() {
            // Test users
            const users = [
                { email: 'test@example.com', password: 'password123' },
                { email: 'admin@example.com', password: 'admin123' }
            ];
            saveCSVData('users', users, ['email', 'password']);

            // Test orders
            const orders = [
                { 
                    id: '1640995200000', 
                    fullname: 'John Doe', 
                    email: 'john@example.com', 
                    items: 'iphone-16;mb-air', 
                    timestamp: '2024-01-01T00:00:00.000Z',
                    userEmail: 'test@example.com'
                }
            ];
            saveCSVData('orders', orders, ['id', 'fullname', 'email', 'items', 'timestamp', 'userEmail']);

            // Load and display
            const loadedUsers = loadCSVData('users');
            const loadedOrders = loadCSVData('orders');

            document.getElementById('output').innerHTML = `
                <h3>Users:</h3>
                <pre>${JSON.stringify(loadedUsers, null, 2)}</pre>
                <h3>Orders:</h3>
                <pre>${JSON.stringify(loadedOrders, null, 2)}</pre>
            `;
        }

        function clearData() {
            localStorage.removeItem('users');
            localStorage.removeItem('orders');
            localStorage.removeItem('currentUser');
            document.getElementById('output').innerHTML = '<p>All data cleared!</p>';
        }

        function downloadUserData() {
            const users = loadCSVData('users');
            const csvContent = arrayToCSV(users, ['email', 'password']);
            downloadCSV('users.csv', csvContent);
        }

        function downloadOrderData() {
            const orders = loadCSVData('orders');
            const csvContent = arrayToCSV(orders, ['id', 'fullname', 'email', 'items', 'timestamp', 'userEmail']);
            downloadCSV('orders.csv', csvContent);
        }
    </script>
</body>
</html>
